<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                template="/pages/californiatemplate/template.xhtml">

    <ui:define name="content">
        <!-- FIX 1: Give the form a unique ID -->
        <h:form id="goalDetailForm" styleClass="p-m-4">

            <!-- Back + Title -->
            <div class="p-d-flex p-ai-center p-mb-3">
                <p:commandButton icon="pi pi-arrow-left"
                                 styleClass="ui-button-text ui-button-outlined p-mr-3"
                                 action="#{individualGoalDetails.backToGoals}"
                                 immediate="true"/>
                <h2 style="margin:0;">Goal Details</h2>
            </div>

            <h:panelGroup rendered="#{not empty individualGoalDetails.selectedGoal}">

                <!-- Goal Info & Donut Progress Section -->
                <div class="p-grid p-mb-4">

                    <!-- LEFT: Goal Information -->
                    <div class="p-col-12 p-md-8">
                        <div class="card p-p-4" style="border-radius:12px;">

                            <!-- Title -->
                            <h3 style="margin-bottom:1rem; font-weight:600; color:#1f2937;">
                                #{individualGoalDetails.selectedGoal.name}
                            </h3>

                            <!-- Info in 2-column layout -->
                            <div class="p-grid p-mb-3">
                                <div class="p-col-6">
                                    <span class="p-d-block"><b>Weight:</b></span>
                                    <span>#{individualGoalDetails.selectedGoal.contributionWeight}%</span>
                                </div>
                                <div class="p-col-6">
                                    <span class="p-d-block"><b>Parent Goal:</b></span>
                                    <span>#{individualGoalDetails.selectedGoal.teamGoal.name}</span>
                                </div>
                                <div class="p-col-6">
                                    <span class="p-d-block"><b>Created On:</b></span>
                                    <h:outputText value="#{individualGoalDetails.selectedGoal.dateCreated}">
                                        <f:convertDateTime pattern="dd MMM yyyy"/>
                                    </h:outputText>
                                </div>
                                <div class="p-col-6">
                                    <span class="p-d-block"><b>Status:</b></span>
                                    <h:outputText value="#{individualGoalDetails.selectedGoal.status}"
                                                  style="color:#2563eb; font-weight:bold;" />
                                </div>
                            </div>

                            <!-- Description -->
                            <div style="margin-top:1rem;">
                                <span class="p-d-block" style="font-weight:600;">Description:</span>
                                <p style="margin:0; color:#374151;">
                                    #{individualGoalDetails.selectedGoal.description}
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT: Knob Progress (Alternative 1) -->
                    <div class="p-col-12 p-md-4">
                        <div class="card p-p-4 p-d-flex p-flex-column p-ai-center p-jc-center"
                             style="border-radius:12px; min-height:100%;">

                            <p:knob value="#{individualGoalDetails.progress}"
                                    disabled="true"
                                    showLabel="true"
                                    labelTemplate="{value}%"
                                    height="100"
                                    width="100"
                                    lineWidth="15"
                                    foregroundColor="#{individualGoalDetails.foregroundColor}" backgroundColor="#e5e7eb"

                                    lineCap="round">
                            </p:knob>

                            <!-- Label below -->
                            <span style="margin-top:1.5rem; color:#6b7280; font-size:1.1rem; font-weight:500;">
            Overall Progress
        </span>
                        </div>
                    </div>

                </div>



                <!-- FIX 2: Give the TabView a unique ID -->
                <p:tabView id="detailsTabView">
                    <p:tab title="KPIs" titleStyle="font-size: medium">
                        <div class="card p-p-4" style="border-radius:12px;">
                            <h3 style="margin-bottom:1rem;">Key Performance Indicators</h3>

                            <div class="p-grid">
                                <ui:repeat value="#{individualGoalDetails.goalKpis}" var="kpi">
                                    <div class="p-col-12 p-md-6 p-lg-4">
                                        <div class="card p-p-3" style="border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.08);">

                                            <!-- KPI Title -->
                                            <h:outputText value="#{kpi.name}"
                                                          style="font-weight:600; font-size:1.1rem; display:block; margin-bottom:0.5rem;" />

                                            <!-- KPI Weight -->
                                            <span style="color:#6b7280; font-size:0.85rem;">
                            Weight: #{kpi.weight}%
                        </span>

                                            <hr style="margin:0.5rem 0;" />

                                            <!-- Progress Bar with Percentage -->
                                            <div class="p-d-flex p-ai-center p-mb-2">
                                                <p:progressBar value="#{kpi.progress}"
                                                               style="flex:1; height:14px; margin-right:1rem;"
                                                               displayOnly="true"
                                                               styleClass="#{kpi.progress ge 80 ? 'ui-bg-success'
                                                          : (kpi.progress ge 50 ? 'bg-warning' : 'bg-danger')}" />
                                                <h:outputText value="#{kpi.progress}%"
                                                              style="font-weight:bold; font-size:1rem;">
                                                    <f:convertNumber maxFractionDigits="1"/>
                                                </h:outputText>
                                            </div>

                                            <!-- KPI Numbers -->
                                            <div class="p-d-flex p-jc-between" style="font-size:0.85rem; color:#6b7280;">
                                                <span>Target: #{kpi.targetValue}</span>
                                                <span>Current: #{kpi.currentValue}</span>
                                            </div>

                                            <!-- Status Badge -->
                                            <div class="p-mt-2">
                            <span class="p-tag
                                         #{kpi.progress ge 80 ? 'p-tag-success'
                                          : (kpi.progress ge 50 ? 'p-tag-warning' : 'p-tag-danger')}">
                                #{kpi.progress ge 80 ? 'On Track'
                                        : (kpi.progress ge 50 ? 'At Risk' : 'Off Track')}
                            </span>
                                            </div>
                                        </div>
                                    </div>
                                </ui:repeat>
                            </div>

                            <h:panelGroup rendered="#{empty individualGoalDetails.goalKpis}">
                                <i>No KPIs linked yet.</i>
                            </h:panelGroup>
                        </div>
                    </p:tab>

                    <p:tab title="Activities" id="indiActivities" titleStyle="font-size: medium">
                        <div class="p-grid">

                            <!-- LEFT: Activities List -->
                            <div class="p-col-12 p-md-4">
                                <p:dataTable value="#{individualGoalDetails.individualActivities}" var="activity"
                                             selection="#{individualGoalDetails.selectedActivity}"
                                             rowKey="#{activity.id}"
                                             paginator="true" rows="10"
                                             paginatorAlwaysVisible="false"
                                             paginatorPosition="bottom"
                                             selectionMode="single"
                                             styleClass="p-datatable-sm p-datatable-striped"
                                             scrollable="true" scrollHeight="400">

                                    <p:column headerText="Activity">
                                        <h:outputText value="#{activity.title}" style="font-weight:500"/>
                                    </p:column>

                                    <!-- FIX: Absolute path for update -->
                                    <p:ajax event="rowSelect"
                                            update=":goalDetailForm:detailsTabView:activityDetailsPanel" />
                                </p:dataTable>
                            </div>

                            <!-- RIGHT: Selected Activity Details -->
                            <div class="p-col-12 p-md-8">
                                <p:panel id="activityDetailsPanel" header="Activity Details"
                                         style="min-height: 400px; border-radius: 8px;">
                                    <h:panelGroup rendered="#{not empty individualGoalDetails.selectedActivity}">

                                        <h3 style="margin-bottom:1rem;">#{individualGoalDetails.selectedActivity.title}</h3>

                                        <!-- Two-column layout -->
                                        <div class="p-grid p-formgrid p-fluid">

                                            <!-- LEFT COLUMN -->
                                            <div class="p-col-12 p-md-6">
                                                <p><b>Description:</b><br/> #{empty individualGoalDetails.selectedActivity.description ? 'Not provided' : individualGoalDetails.selectedActivity.description}</p>
                                                <p><b>Status:</b> #{individualGoalDetails.selectedActivity.status}</p>
                                                <p><b>Priority:</b> #{individualGoalDetails.selectedActivity.priority}</p>
                                            </div>

                                            <!-- RIGHT COLUMN -->
                                            <div class="p-col-12 p-md-6">
                                                <p><b>Type:</b> #{individualGoalDetails.selectedActivity.activityType}</p>
                                                <p><b>Planned Start:</b>
                                                    <h:outputText value="#{individualGoalDetails.selectedActivity.plannedStartDate}">
                                                        <f:convertDateTime pattern="dd MMM yyyy"/>
                                                    </h:outputText>
                                                </p>
                                                <p><b>Planned End:</b>
                                                    <h:outputText value="#{individualGoalDetails.selectedActivity.plannedEndDate}">
                                                        <f:convertDateTime pattern="dd MMM yyyy"/>
                                                    </h:outputText>
                                                </p>
                                            </div>
                                        </div>

                                    </h:panelGroup>

                                    <h:panelGroup rendered="#{empty individualGoalDetails.selectedActivity}">
                                        <i>Select an activity from the list to view details.</i>
                                    </h:panelGroup>
                                </p:panel>
                            </div>


                        </div>
                    </p:tab>

                </p:tabView>
            </h:panelGroup>

        </h:form>

        <!-- If no goal selected -->
        <h:panelGroup rendered="#{empty individualGoalDetails.selectedGoal}">
            <h:outputText value="No goal selected." style="color:#9ca3af;"/>
        </h:panelGroup>
    </ui:define>
</ui:composition>
