<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                template="/pages/californiatemplate/template.xhtml">

    <ui:define name="head">
        <title>KPI Details</title>
        <style>
            .kpi-detail-container {
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
            }
            .kpi-header {
                background: #f8f9fa;
                padding: 20px;
                border-radius: 8px;
                margin-bottom: 20px;
                border-left: 4px solid #3b82f6;
            }
            .kpi-title {
                font-size: 1.5rem;
                font-weight: 600;
                color: #1f2937;
                margin: 0 0 10px 0;
            }
            .kpi-info-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
                margin-bottom: 30px;
            }
            .kpi-info-item {
                background: white;
                padding: 15px;
                border-radius: 6px;
                border: 1px solid #e5e7eb;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
            .kpi-info-label {
                font-size: 0.875rem;
                color: #6b7280;
                margin-bottom: 5px;
                font-weight: 500;
            }
            .kpi-info-value {
                font-size: 1rem;
                color: #1f2937;
                font-weight: 600;
            }
            .progress-bar-container {
                position: relative;
                background: #e5e7eb;
                height: 25px;
                border-radius: 12px;
                overflow: hidden;
            }
            .progress-bar {
                height: 100%;
                transition: width 0.3s ease;
                border-radius: 12px;
            }
            .progress-text {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 0.75rem;
                font-weight: 600;
                color: white;
                text-shadow: 1px 1px 1px rgba(0,0,0,0.3);
            }
            .progress-table .ui-datatable-data tr td {
                vertical-align: middle !important;
            }
            .progress-section {
                background: white;
                padding: 20px;
                border-radius: 8px;
                border: 1px solid #e5e7eb;
                margin-bottom: 30px;
            }
            .progress-header {
                font-size: 1.1rem;
                font-weight: 600;
                color: #1f2937;
                margin-bottom: 15px;
            }
            .progress-bar-container {
                background: #f3f4f6;
                border-radius: 10px;
                height: 20px;
                overflow: hidden;
                margin-bottom: 10px;
            }
            .progress-bar {
                height: 100%;
                background: linear-gradient(90deg, #10b981, #059669);
                border-radius: 10px;
                transition: width 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: flex-end;
                padding-right: 10px;
            }
            .progress-text {
                color: white;
                font-size: 0.875rem;
                font-weight: 600;
            }
            .chart-section {
                background: white;
                padding: 20px;
                border-radius: 8px;
                border: 1px solid #e5e7eb;
                margin-bottom: 30px;
            }
            .chart-header {
                font-size: 1.1rem;
                font-weight: 600;
                color: #1f2937;
                margin-bottom: 15px;
            }
            .updates-table {
                margin-top: 30px;
            }
            .back-button {
                margin-bottom: 20px;
            }
            .update-value-btn {
                position: absolute;
                top: 20px;
                right: 20px;
            }
            .breadcrumb-card {
                padding: 3px 6px;
                margin-bottom: 8px;
            }
            .breadcrumb-card .ui-breadcrumb {
                font-size: .8rem;
                padding: 0;
                margin: 0;
            }
            .breadcrumb-card .ui-breadcrumb .ui-menuitem-link {
                padding: 1px 6px;
            }
        </style>
    </ui:define>

    <ui:define name="content">
        <div class="kpi-detail-container">
            <h:form id="kpiDetailForm">
                
                <!-- Breadcrumb -->
                <div class="card breadcrumb-card">
                    <p:breadCrumb>
                        <p:menuitem value="Dashboard" icon="pi pi-home" outcome="/pages/dashboard/Dashboard" />
                        <p:menuitem value="KPIs" icon="pi pi-chart-bar" action="#{kpiDetailView.goBack()}" />
                        <p:menuitem value="KPI Details" icon="pi pi-eye" />
                    </p:breadCrumb>
                </div>

                <!-- Back Button and Update Value Button -->
                <div style="position: relative; margin-bottom: 20px;">
                    <p:commandButton value="â† Back" icon="pi pi-arrow-left" 
                                     styleClass="ui-button-secondary back-button"
                                     action="#{kpiDetailView.goBack()}" />
                    
                    <p:commandButton value="Update value" icon="pi pi-pencil" 
                                     styleClass="ui-button-success update-value-btn"
                                     onclick="PF('updateValueDialog').show()" />
                </div>

                <!-- KPI Header -->
                <div class="kpi-header">
                    <h2 class="kpi-title">#{kpiDetailView.selectedKpi.name}</h2>
                </div>

                <!-- KPI Information Grid -->
                <div class="kpi-info-grid">
                    <div class="kpi-info-item">
                        <div class="kpi-info-label">Goal:</div>
                        <div class="kpi-info-value">#{kpiDetailView.goalName}</div>
                    </div>
                    <div class="kpi-info-item">
                        <div class="kpi-info-label">Target Value:</div>
                        <div class="kpi-info-value">#{kpiDetailView.selectedKpi.targetValue}</div>
                    </div>
                    <div class="kpi-info-item">
                        <div class="kpi-info-label">Current Value:</div>
                        <div class="kpi-info-value">#{kpiDetailView.selectedKpi.currentValue}</div>
                    </div>
                    <div class="kpi-info-item">
                        <div class="kpi-info-label">Measurement Unit:</div>
                        <div class="kpi-info-value">#{kpiDetailView.selectedKpi.measurementUnit != null ? kpiDetailView.selectedKpi.measurementUnit.displayName : 'N/A'}</div>
                    </div>
                    <div class="kpi-info-item">
                        <div class="kpi-info-label">Frequency:</div>
                        <div class="kpi-info-value">#{kpiDetailView.selectedKpi.frequency != null ? kpiDetailView.selectedKpi.frequency.displayName : 'N/A'}</div>
                    </div>
                    <div class="kpi-info-item">
                        <div class="kpi-info-label">Start Date:</div>
                        <div class="kpi-info-value">
                            <h:outputText value="#{kpiDetailView.selectedKpi.startDate}">
                                <f:convertDateTime pattern="dd MMM, yyyy" />
                            </h:outputText>
                        </div>
                    </div>
                    <div class="kpi-info-item">
                        <div class="kpi-info-label">Review Cycle:</div>
                        <div class="kpi-info-value">#{kpiDetailView.selectedKpi.reviewCycle != null ? kpiDetailView.selectedKpi.reviewCycle.title : 'Not Assigned'}</div>
                    </div>
                </div>
                

                <!-- Progress Section -->
                <div class="chart-section">
                    <div class="chart-header">KPI Progress Over Time</div>
                    <div class="progress-visualization">
                        <p:dataTable value="#{kpiDetailView.chartDataPoints}" var="point"
                                     styleClass="progress-table" reflow="true">
                            <p:column headerText="Month" style="width:40%">
                                <h:outputText value="#{point.label}" />
                            </p:column>
                            <p:column headerText="Value" style="width:30%">
                                <h:outputText value="#{point.value}" />
                            </p:column>
                            <p:column headerText="Progress" style="width:30%">
                                <div class="progress-bar-container">
                                    <div class="progress-bar" style="width: #{point.value}%; background-color: #28a745;"></div>
                                    <span class="progress-text">#{point.value}%</span>
                                </div>
                            </p:column>
                        </p:dataTable>
                    </div>
                </div>

                <!-- Updates Table -->
                <div class="card updates-table">
                                        <p:panel header="Update History" styleClass="ui-panel-no-border">
                        <p:outputText value="Update history is fetched from the KpiUpdateHistory database table. Each update includes the date, value, user who made the update, and optional comments." 
                                      style="font-style: italic; color: #666; font-size: 0.9em;" />
                        <p:spacer height="10" />
                        
                        <p:dataTable id="updateHistoryTable" 
                                     var="update" 
                                     value="#{kpiDetailView.kpiUpdates}" 
                                     emptyMessage="No update history available"
                                     paginator="true" 
                                     rows="10" 
                                     paginatorPosition="bottom"
                                     styleClass="history-table">
                            
                            <p:column headerText="Date Updated" width="20%">
                                <h:outputText value="#{update.dateUpdated}">
                                    <f:convertDateTime pattern="MMM dd, yyyy HH:mm" />
                                </h:outputText>
                            </p:column>
                            
                            <p:column headerText="Value" width="15%">
                                <h:outputText value="#{update.value}" styleClass="value-text">
                                    <f:convertNumber pattern="#,##0.00" />
                                </h:outputText>
                            </p:column>
                            
                            <p:column headerText="Updated By" width="25%">
                                <h:outputText value="#{update.updatedBy.firstName} #{update.updatedBy.lastName}" />
                            </p:column>
                            
                            <p:column headerText="Comments" width="40%">
                                <h:outputText value="#{update.comment}" 
                                              rendered="#{not empty update.comment}" />
                                <h:outputText value="No comment provided" 
                                              style="font-style: italic; color: #999;" 
                                              rendered="#{empty update.comment}" />
                            </p:column>
                        </p:dataTable>
                    </p:panel>
                </div>

            </h:form>
        </div>

        <!-- Update Value Dialog -->
        <p:dialog header="Update KPI Value" widgetVar="updateValueDialog" 
                  modal="true" resizable="false" width="400" height="300">
            <h:form id="updateValueForm">
                <div class="ui-g ui-fluid">
                    <div class="ui-g-12">
                        <p:outputLabel for="newValue" value="New KPI Value:" />
                        <p:inputNumber id="newValue" value="#{kpiDetailView.newValue}" 
                                      decimalPlaces="2" required="true" 
                                      placeholder="Enter the new value for this KPI"/>
                    </div>
                    <div class="ui-g-12">
                        <p:outputLabel for="comment" value="Update Comment (Optional):" />
                        <p:inputTextarea id="comment" value="#{kpiDetailView.updateComment}" 
                                         rows="3" cols="30" 
                                         placeholder="Add a comment about this update (optional)"/>
                    </div>
                    <div class="ui-g-12" style="text-align: right; margin-top: 20px;">
                        <p:commandButton value="Cancel" icon="pi pi-times" 
                                         styleClass="ui-button-secondary"
                                         onclick="PF('updateValueDialog').hide()" 
                                         type="button" />
                        <p:commandButton value="Update" icon="pi pi-check" 
                                         styleClass="ui-button-success"
                                         action="#{kpiDetailView.updateKpiValue()}"
                                         update="kpiDetailForm:updatesTable, kpiDetailForm"
                                         oncomplete="PF('updateValueDialog').hide()" />
                    </div>
                </div>
            </h:form>
        </p:dialog>

    </ui:define>
</ui:composition>
